<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Restaurant Search</ion-title>
    <ion-button slot="end" fill="clear" (click)="toggleOptimizedMode()">
      {{ store.useOptimizedMode() ? 'OSM最適化: ON' : 'OSM最適化: OFF' }}
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="map-container">
    <div #mapContainer class="map-canvas"></div>
    
    @if (store.isLoading()) {
      <div class="loading-overlay">
        <ion-spinner name="circular"></ion-spinner>
      </div>
    }
  </div>

  <!-- Restaurant Details Modal -->
  <ion-modal 
    [isOpen]="store.isSheetOpen()"
    [breakpoints]="[0.25, 0.5, 0.75]"
    [initialBreakpoint]="0.5"
    (ionModalDidDismiss)="onSheetDismiss()">
    
    <ng-template>
      <ion-content>
        @if (store.currentRestaurant()) {
          <div class="restaurant-details">
            <ion-item lines="none" class="restaurant-header">
              <ion-label>
                <h1>{{ store.currentRestaurant()?.name }}</h1>
                <div class="rating">
                  <span class="stars">{{ getStars(store.currentRestaurant()?.rating || 0) }}</span>
                  <span class="rating-number">{{ formatRating(store.currentRestaurant()?.rating || 0) }}</span>
                </div>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-label>
                <h3>Address</h3>
                <p>{{ store.currentRestaurant()?.address }}</p>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-label>
                <h3>Opening Hours</h3>
                <p>{{ store.currentRestaurant()?.openingHours }}</p>
              </ion-label>
            </ion-item>

            @if (store.currentBuildingPolygon() || store.currentOsmBuildingId()) {
              <ion-item lines="none" class="building-info">
                <ion-label>
                  <h3>建物情報</h3>
                  <ion-text color="medium">
                    @if (store.useOptimizedMode() && store.currentOsmBuildingId()) {
                      <p>OSM ID: {{ store.currentOsmBuildingId() }}</p>
                      <small>🚀 最適化モード: OSM IDから建物形状を高速取得</small>
                    } @else if (store.currentBuildingPolygon()) {
                      <p>建物種類: {{ store.currentBuildingPolygon()?.properties?.building || '建物' }}</p>
                      @if (store.currentBuildingPolygon()?.properties?.name) {
                        <p>建物名: {{ store.currentBuildingPolygon()?.properties?.name }}</p>
                      }
                      @if (store.currentBuildingPolygon()?.properties?.osm_id) {
                        <p>OSM ID: {{ store.currentBuildingPolygon()?.properties?.osm_id }}</p>
                      }
                      <small>🐌 従来モード: GeoJSONポリゴンデータを使用</small>
                    }
                    <br><small>薄い青色の塗りつぶし: 実際の建物ポリゴン (OpenStreetMap)</small>
                  </ion-text>
                </ion-label>
              </ion-item>
            }

            @if (store.searchMessage()) {
              <ion-item lines="none">
                <ion-label>
                  <ion-text color="medium">
                    <p>{{ store.searchMessage() }}</p>
                  </ion-text>
                </ion-label>
              </ion-item>
            }

            <div class="actions">
              <ion-button fill="clear" (click)="onSheetDismiss()">
                Close
              </ion-button>
            </div>
          </div>
        }
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Error Toast -->
  <ion-toast
    [isOpen]="!!store.error()"
    [message]="store.error() || ''"
    duration="3000"
    color="danger"
    position="top">
  </ion-toast>
</ion-content>